'''
ì €ì ì„ ì°¾ëŠ” ìŠ¤í¬ë¦½íŠ¸
signal_any_drop ë¥¼ í†µí•´ì„œ 5ì¼ì„ ì´ 20ì¼ì„ ë³´ë‹¤ ì•„ë˜ì— ìˆìœ¼ë©´ì„œ ìµœê·¼ -3%ì´ ì¡´ì¬ + ì˜¤ëŠ˜ 3% ì´ìƒ ìƒìŠ¹
'''
import matplotlib
matplotlib.use("Agg")  # âœ… ë¹„ì¸í„°ë™í‹°ë¸Œ ë°±ì—”ë“œ (ì°½ ì•ˆ ë„ì›€)
import os, sys
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import unicodedata
from pathlib import Path
import matplotlib.pyplot as plt
import requests
import time
from concurrent.futures import ThreadPoolExecutor, ProcessPoolExecutor, as_completed


# ìë™ íƒìƒ‰ (utils.pyë¥¼ ì°¾ì„ ë•Œê¹Œì§€ ìœ„ë¡œ ì˜¬ë¼ê°€ íƒìƒ‰)
here = Path(__file__).resolve()
for parent in [here.parent, *here.parents]:
    if (parent / "utils.py").exists():
        sys.path.insert(0, str(parent))
        break
else:
    raise FileNotFoundError("utils.pyë¥¼ ìƒìœ„ ë””ë ‰í„°ë¦¬ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

from utils import get_kor_ticker_dict_list, add_technical_features, plot_candles_weekly, plot_candles_daily, \
    drop_sparse_columns, drop_trading_halt_rows, signal_any_drop, low_weekly_check


VOL_WINDOW = 30


def _col(df, ko: str, en: str):
    """í•œêµ­/ì˜ë¬¸ ì¹¼ëŸ¼ ìë™ë§¤í•‘: koê°€ ìˆìœ¼ë©´ ko, ì—†ìœ¼ë©´ enì„ ë°˜í™˜"""
    if ko in df.columns: return ko
    return en


# í˜„ì¬ ì‹¤í–‰ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¡ê¸°
root_dir = os.path.dirname(os.path.abspath(__file__))  # ì‹¤í–‰í•˜ëŠ” íŒŒì´ì¬ íŒŒì¼ ìœ„ì¹˜(=ë£¨íŠ¸)
pickle_dir = os.path.join(root_dir, 'pickle')

# pickle í´ë”ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„± (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
os.makedirs(pickle_dir, exist_ok=True)


# tickers = list(tickers_dict.keys())
# # 3í¼
# tickers = ['012630', '002710', '121600', '393890', '086520', '418550', '052400', '123410', '137400', '015760', '138930',
#            '060720', '002900', '003090', '033500', '017510', '396300', '079900', '023440', '032500', '002020', '323280',
#            '393210', '371950', '051600', '417200', '006650', '317330', '025900', '003030', '022100', '033790', '042660',
#            '086280', '307950', '298020', '234920', '289220', '078020', '030610', '069620', '194480', '217500', '003230',
#            '001720', '214430', '007820', '226400', '440320', '039020', '351330', '216080', '214450', '389140', '003380',
#            '000880', '489790', '042670', '100090', '085670', '065350', '114840', '317770', '035720', '220100', '460930',
#            '011200', '006120', '092730', '004140', '082800', '299660', '054950', '464080', '473980', '389260', '251970',
#            '079550', '037270', '036620', '023590', '032190', '376300', '141080', '377450', '439580', '000520', '000250',
#            '008490', '304100', '298380', '082270', '950160', '036420', '950210', '123690', '030520', '003530', '200670',
#            '019490', '358570', '388870', '161890', '290690', '041190', '065680', '257720', '094480', '377480', '026890',
#            '347860', '476080', '205500', '413640', '357550', '347700', '052710', '061040', '007460', '950140', '417840',
#            '448710', '103140', '499790', '293780', '083310', '089790', '388610', '372320', '001040', '009450', '389650',
#            '000320', '110990', '418420', '000400', '378800', '464500', '322310', '074600', '036200', '032680', '002790',
#            '078520', '012030', '060250', '036530', '251270', '128820', '109740', '201490', '099440', '451220', '036220',
#            '041830', '033230', '452160', '089590', '263860', '272450', '042000', '192250', '029460', '294570', '192400',
#            '259960', '425420', '053300', '092070', '315640', '104830', '425040', '474610', '003570', '007980', '082640',
#            '314930', '199480', '082920', '424960', '092040', '461300', '158430', '048530', '006220', '078340', '384470',
#            '054920', '482630', '014620', '095700', '445180', '213420', '429270', '265520', '114090', '025320', '099320',
#            '200710', '295310', '083500', '034230', '008770', '142760', '322780', '009070', '047400', '001045', '255220',
#            '475150', '420770', '045390', '083650', '365340', '025980', '041510', '122640', '105840', '091120', '094820',
#            '018470', '362320', '192820', '024720', '214420', '003350', '101170', '009540', '267270', '071970', '305090',
#            '178320', '475580', '217820', '053690', '180640', '399720', '005290', '474170', '059090', '452430', '005935',
#            '001820', '357780', '445090', '033160', '032820', '047560', '389020', '355150', '021240', '405100', '219130',
#            '009830']


# 4í¼
tickers = ['002710', '418550', '052400', '137400', '015760', '060720', '002900', '003090', '033500', '017510', '023440',
           '032500', '002020', '323280', '371950', '417200', '121600', '006650', '317330', '025900', '393210', '022100',
           '307950', '298020', '289220', '078020', '030610', '194480', '217500', '003230', '001720', '214430', '007820',
           '226400', '440320', '039020', '351330', '214450', '389140', '003380', '000880', '489790', '042660', '042670',
           '100090', '085670', '065350', '035720', '220100', '092730', '086280', '114840', '464080', '079550', '037270',
           '473980', '023590', '032190', '376300', '141080', '377450', '439580', '000520', '000250', '008490', '304100',
           '298380', '082270', '950160', '036420', '950210', '123690', '030520', '003530', '460930', '200670', '019490',
           '358570', '388870', '290690', '065680', '257720', '026890', '347860', '476080', '036620', '205500', '389260',
           '413640', '357550', '347700', '007460', '950140', '417840', '103140', '499790', '299660', '293780', '083310',
           '089790', '372320', '389650', '000320', '110990', '418420', '378800', '036200', '032680', '002790', '001040',
           '012030', '060250', '036530', '251270', '128820', '109740', '201490', '099440', '036220', '041190', '041830',
           '033230', '089590', '263860', '272450', '192250', '192400', '425420', '315640', '104830', '007980', '314930',
           '199480', '082920', '424960', '092040', '461300', '158430', '078520', '048530', '006220', '384470', '054920',
           '095700', '445180', '213420', '429270', '265520', '092070', '025320', '099320', '200710', '295310', '083500',
           '322310', '042000', '034230', '008770', '322780', '052710', '047400', '001045', '114090', '255220', '475150',
           '420770', '045390', '083650', '365340', '025980', '464500', '041510', '122640', '105840', '091120', '094820',
           '079900', '024720', '214420', '251970', '101170', '267270', '071970', '082640', '305090', '178320', '053690',
           '180640', '399720', '005290', '059090', '452430', '001820', '357780', '445090', '033160', '355150', '405100',
           '219130']



def process_one(idx, count, ticker, tickers_dict):
    stock_name = tickers_dict.get(ticker, 'Unknown Stock')
    # print(f"Processing {count+1}/{len(tickers)} : {stock_name} [{ticker}]")

    filepath = os.path.join(pickle_dir, f'{ticker}.pkl')
    if not os.path.exists(filepath):
        print(f"[idx={idx}] {ticker} íŒŒì¼ ì—†ìŒ")
        return

    df = pd.read_pickle(filepath)


    # idxë§Œí¼ ë’¤ì—ì„œ ìë¥¸ë‹¤ (idxê°€ 2ë¼ë©´ 2ì¼ ì „ ë°ì´í„°ì…‹)
    if idx != 0:
        data = df[:-idx]
        remaining_data = df[len(df)-idx:]
    else:
        data = df
        remaining_data = None

    today = data.index[-1].strftime("%Y%m%d") # ë§ˆì§€ë§‰ ì¸ë±ìŠ¤
    if count == 0:
        # print(data)
        # print('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')
        print(data.index[-1].date())
        # print('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€')


    ########################################################################

    closes = data['ì¢…ê°€'].values
    trading_value = data['ê±°ë˜ëŸ‰'] * data['ì¢…ê°€']


    # ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ íŒ¨ìŠ¤
    if data.empty or len(data) < 70:
        # print(f"                                                        ë°ì´í„° ë¶€ì¡± â†’ pass")
        return

    # 2ì°¨ ìƒì„± feature
    data = add_technical_features(data)

    # ê²°ì¸¡ ì œê±°
    cleaned, cols_to_drop = drop_sparse_columns(data, threshold=0.10, check_inf=True, inplace=True)
    data = cleaned

    # ê±°ë˜ì •ì§€/ì´ìƒì¹˜ í–‰ ì œê±°
    data, removed_idx = drop_trading_halt_rows(data)


    if 'MA5' not in data.columns or 'MA20' not in data.columns:
        return

    # ë§ˆì§€ë§‰ ì¼ì 5ì¼ì„ ì€ 20ì¼ì„ ë³´ë‹¤ ë‚®ì•„ì•¼ í•œë‹¤
    ma5_today = data['MA5'].iloc[-1]
    ma20_today = data['MA20'].iloc[-1]
    ma20_yesterday = data['MA20'].iloc[-2]

    if ma5_today >= ma20_today:
        return

    # ë³€í™”ìœ¨ ê³„ì‚° (í¼ì„¼íŠ¸ë¡œ ë³´ë ¤ë©´ * 100)
    ma20_chg_rate = (ma20_today - ma20_yesterday) / ma20_yesterday * 100

    # â˜…â˜…â˜…â˜…â˜… 20ì¼ì„  ê¸°ìš¸ê¸° â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    if ma20_chg_rate < -1.7:
        return


    # ì§ì „ ë‚ ê¹Œì§€ì˜ ë§ˆì§€ë§‰ 3ì¼ ê±°ë˜ëŒ€ê¸ˆ í‰ê· 
    today_tr_val = trading_value.iloc[-1]
    mean_prev3 = trading_value.iloc[:-1].tail(3).mean()
    chg_tr_val = (today_tr_val-mean_prev3)/mean_prev3*100

    # â˜…â˜…â˜…â˜…â˜… 3ê±°ë˜ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ 5ì–µë³´ë‹¤ ì‘ìœ¼ë©´ íŒ¨ìŠ¤ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    if mean_prev3.round(1) / 100_000_000 < 5:
        return




    # â˜…â˜…â˜…â˜…â˜… ê±°ë˜ëŒ€ê¸ˆ ë³€ë™ë¥ , ++ ë„ˆë¬´ í¬ë©´ ì°¨ìµì‹¤í˜„ìœ¼ë¡œ í•˜ë½ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # -25/500: 46.46%
    # -22/500: 46.22%
    # -20/500: 46.64% â˜…â˜…â˜…â˜…â˜…
    # -20/400: 46.05%
    # -15/500: 45.97%
    # -10/500: 46.63%
    #  -5/500: 46.60%
    #   0/500: 46.27%
    if chg_tr_val < -20 or chg_tr_val > 500:
        return

    # â˜…â˜…â˜…â˜…â˜… ì˜¤ëŠ˜ 15% ì´ìƒ ì˜¤ë¥´ë©´ íŒ¨ìŠ¤ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # 10: 44.74%
    # 11: 45.41%
    # 12: 45.81%
    # 13: 46.08%
    # 14: 46.38%
    # 15: 46.63% â˜…â˜…â˜…â˜…â˜…
    if data.iloc[-1]['ë“±ë½ë¥ '] > 15:
        return

    # â˜…â˜…â˜…â˜…â˜… ìµœê·¼ 20ì¼ ë³€ë™ì„± ë„ˆë¬´ ë‚®ìœ¼ë©´ ì œì™¸ (ì§€ë£¨í•œ ì¢…ëª©) â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    last20_ret = data['ë“±ë½ë¥ '].tail(20)           # ë“±ë½ë¥ ì´ % ë‹¨ìœ„ë¼ê³  ê°€ì •
    last30_ret = data['ë“±ë½ë¥ '].tail(30)
    vol20 = last20_ret.std()                      # í‘œì¤€í¸ì°¨
    if vol20 < 1.5:                               # í•„ìš”í•˜ë©´ 2.0~3.0 ì‚¬ì´ë¡œ íŠœë‹
        return

    # 4) ìµœê·¼ 20ì¼ í‰ê·  ë“±ë½ë¥ ì´ ê³„ì† ë§ˆì´ë„ˆìŠ¤ì¸ ì¢…ëª© ì œì™¸ (ìš°í•˜í–¥ ê¸°ëŠ” ëŠë‚Œ)
    mean_ret20 = last30_ret.mean()
    if mean_ret20 < -0.5:                           # -3% ì´í•˜ë©´ ì¥ê¸° í•˜ë½ ê¸°ì¡°
        return

    # 5) ìµœê·¼ 20ì¼ ì¤‘ ì–‘ë´‰ ë¹„ìœ¨ì´ 30% ë¯¸ë§Œì´ë©´ ì œì™¸ (ê³„ì† ìŒë´‰ ìœ„ì£¼) â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    pos_ratio = (last30_ret > 0).mean()           # True ë¹„ìœ¨ => ì–‘ë´‰ ë¹„ìœ¨
    if pos_ratio < 0.3:
        return











    # ìµœê·¼ 12ì¼ 5ì¼ì„ ì´ 20ì¼ì„ ë³´ë‹¤ ë‚®ì€ë° 3% í•˜ë½ì´ ìˆìœ¼ë©´ì„œ ì˜¤ëŠ˜ 3% ìƒìŠ¹ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # ë³€ê²½ì ...  10ì¼ +- 3ì¼ë¡œ ì„¤ì •í•´ë´ì•¼ í• ì§€ë„
    # ë³€ê²½ì ... -2.5% +- 0.5% ì„¤ì •í•´ë´ì•¼ í• ì§€ë„
    # signal = signal_any_drop(data, 10, 4.0 ,-2.5)
    signal = signal_any_drop(data, 10, 4.0 ,-2.5)
    if not signal:
        return


    ########################################################################

    m_data = data[-80:] # ë’¤ì—ì„œ xê°œ (4ê°œì›” ì •ë„)


    m_closes = m_data['ì¢…ê°€']
    m_max = m_closes.max()
    m_min = m_closes.min()
    m_current = m_closes[-1]

    r_data = remaining_data[:10]
    r_closes = r_data['ì¢…ê°€']
    r_max = r_closes.max()

    m_chg_rate=(m_max-m_min)/m_min*100              # ìµœê·¼ 4ê°œì›” ë™ì•ˆì˜ ë“±ë½ë¥ 
    c_chg_rate=(m_current-m_max)/m_max*100          # ìµœê·¼ 4ê°œì›” ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥  ê³„ì‚°
    r_chg_rate = (r_max-m_current)/m_current*100    # ê²€ì¦ ë“±ë½ë¥ 

    # â˜…â˜…â˜…â˜…â˜… ìµœê·¼ 4ê°œì›” ìµœê³  ëŒ€ë¹„ ë„ˆë¬´ ë‚´ë ¤ ì•‰ìœ¼ë©´ íŒ¨ìŠ¤ (ë³´ìˆ˜ì ìœ¼ë¡œ) â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # -40: 46.64% (104/119)
    # -30  46.63% (89/99)

    # 0/40: 46.64%
    # 0/30: 46.63%
    # -5/40: 47.25%
    # -5/30: 47.34%
    # -10/40: 46.31%
    # -10/30: 46.24%

    # -15/40: 43.40%
    # if c_chg_rate > -5 or c_chg_rate < -30:
    if c_chg_rate < -40:
        return

    # â˜…â˜…â˜…â˜…â˜… ìµœì € ëŒ€ë¹„ ìµœê³  ë“±ë½ë¥ , ìµœê·¼ ë³€ë™ë¥  ìµœì†Œ ê¸°ì¤€: íš¡ë³´ or ì‹¬í•œ ë³€ë™ ì œì™¸ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    # 27/80: 46.25%
    # 25/80: 46.25%
    # 27/75: 45.89%
    # 25/75: 45.89%
    # 27/70: 44.91%
    # 25/70: 44.91%
    # 20/80: 46.43%
    # 30/80: 47.47%
    # 35/80: 47.71%
    # 40/80: 50.00% (65/65)
    # 45/80: 49.51%
    # 50/80: 51.85% (39/42)
    if m_chg_rate < 30 or m_chg_rate > 80:
        return


    result = low_weekly_check(m_data)
    if result["ok"]:

        # â˜…â˜…â˜…â˜…â˜… ì €ë²ˆì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ì¦ê°ë¥  -1%ë³´ë‹¤ ë‚®ìœ¼ë©´ íŒ¨ìŠ¤ (ì•„ì§ í•˜ë½ ì¶”ì„¸) â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        if result["is_drop_more_than_minus3pct"]:
            return

        # â˜…â˜…â˜…â˜…â˜… ì§€ë‚œì£¼ ëŒ€ë¹„ ì£¼ë´‰ ì¢…ê°€ê°€ 15% ì´ìƒ ìƒìŠ¹í•˜ë©´ íŒ¨ìŠ¤ â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        # 15: 46.25%
        # 13: 45.49%
        # 11: 44.19%
        if result['pct_change'] * 100 > 15:
            return

        # â˜…â˜…â˜…â˜…â˜… 4ê°œì›” ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥ : ë„ˆë¬´ í•˜ë½í•œê²ƒ ì œì™¸ (ëª© ëŒì•„ê°) ++ ë„ˆë¬´ ìƒìŠ¹í•˜ë©´ ì•ˆì˜¬ë¼ê° (ë³´ìˆ˜ì ìœ¼ë¡œ ìŠ¹ë¥ ì„ ì˜¬ë¦¬ê¸° ìœ„í•´ 30ì—ì„œ 20ìœ¼ë¡œ ë‚´ë¦¼)
        # -30: 46.25%
        # -25: 46.64%
        # -20: 46.53%
        # -25/30: 46.12%
        # -25/25: 45.41%
        # -25/20: 45.30%
        # -25/15: 43.27%
        # -25/10: 41.45%
        # if result['pct_vs_past_first'] > 30 or result['pct_vs_past_first'] < -25: â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        # if result['pct_vs_past_first'] < -25:
        if result['pct_vs_past_first'] < -20:
            return

        # 50/-20/-20 ì¡°ê±´ í…ŒìŠ¤íŠ¸ !!!!!!!!!!!!!!!!!!!!
        # if m_chg_rate < 60 and result['pct_vs_past_first'] < -17 and c_chg_rate < -19:
        # none:       47.09% (105/118)
        # 60/-20/-20: 47.85% (100/109)
        # if m_chg_rate > 60 and result['pct_vs_past_first'] < -20 and c_chg_rate < -20:
        #     return

        # ì• ë§¤í•œ ê³ ì  ê·¼ì²˜ íŒ¨í„´ ì»·
        # if (-18 <= c_chg_rate <= -10 and
        #         result['pct_change']*100 >= 5 and
        #         data.iloc[-1]['ë“±ë½ë¥ '] >= 5):
        #     return


        # â˜…â˜…â˜…â˜…â˜… ì˜¤ëŠ˜ì´ ì´ë¯¸ ê±°ì˜ í”¼í¬ ëŠë‚Œì¸ ì¥ëŒ€ì–‘ë´‰
        # ì˜¤ëŠ˜ ë“±ë½ë¥  9ì´ìƒ
        # ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥  9ì´ìƒ
        # ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥  5% ë¯¸ë§Œ)
        # on > 40.91%
        # off > 41.35

        # 7/7/-10: 46.48%
        # 7/7/-15: 46.54%
        # 7/7/-20: 46.12%

        # 8/8/-15: 46.12%
        # 9/9/-15: 46.36%

        # ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥ 
        # ì˜¤ëŠ˜ë“±ë½ë¥ 
        # 4ê°œì›” ì¢…ê°€ ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥ 
        # 4ê°œì›” ì£¼ë´‰ ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥ 
        # if result['pct_change']*100 > 6 and \
        #     data.iloc[-1]['ë“±ë½ë¥ '] > 6 and \
        #     c_chg_rate < -15 and \
        #     result['pct_vs_past_first'] < 5:
        #     return

        predict = 'ìƒìŠ¹'
        if r_chg_rate < 8:
            predict = 'ë¯¸ë‹¬'

        label = 1 if r_chg_rate >= 5 else 0  # 1: ì„±ê³µ(ìƒìŠ¹), 0: ë¯¸ë‹¬

    ########################################################################

    row = {
        "ticker": ticker,
        "stock_name": stock_name,
        "label": label,
        "today" : str(data.index[-1].date()),
        "4_months_ago": str(m_data.index[0].date()),
        "ma20_chg_rate": round(ma20_chg_rate, 2),                # 20ì¼ì„  ê¸°ìš¸ê¸°
        "vol20": round(vol20, 1),                                # 20ì¼ í‰ê·  ë³€ë™ì„±
        "mean_ret20": round(mean_ret20, 1),                      # 20ì¼ í‰ê·  ë“±ë½ë¥ 
        "pos_ratio": round(pos_ratio*100, 1),                    # 30ì¼ í‰ê·  ì–‘ë´‰ë¹„ìœ¨
        "predict": predict,                                      # ìƒìŠ¹/ë¯¸ë‹¬
        "mean_prev3": round(mean_prev3, 1),                      # ì§ì „ 3ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ
        "today_tr_val": round(today_tr_val, 1),                  # ì˜¤ëŠ˜ ê±°ë˜ëŒ€ê¸ˆ
        "chg_tr_val": round(chg_tr_val, 1),                      # ê±°ë˜ëŒ€ê¸ˆ ë³€ë™ë¥ 
        "m_chg_rate": round(m_chg_rate, 1),                      # 4ê°œì›” ì¢…ê°€ ìµœì € ëŒ€ë¹„ ìµœê³  ë“±ë½ë¥ 
        "c_chg_rate": round(c_chg_rate, 1),                      # 4ê°œì›” ì¢…ê°€ ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥ 
        "pct_vs_first": round(result['pct_vs_past_first'], 1),   # 4ê°œì›” ì£¼ë´‰ ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥ 
        "pct_vs_lastweek": round(result['pct_change']*100, 1),   # ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥ 
        "today_pct": round(data.iloc[-1]['ë“±ë½ë¥ '], 1),           # ì˜¤ëŠ˜ë“±ë½ë¥ 
        "r_chg_rate": round(r_chg_rate, 1),                      # ê²€ì¦ ë“±ë½ë¥ 
    }

    origin = df.copy()


    #ì—°ì‚°í•˜ëŠ” ì‹œê°„ ê±¸ë¦¬ë‹ˆ ê·¸ë˜í”„ ì•ˆê·¸ë¦¬ë©´ íŒ¨ìŠ¤
    # 2ì°¨ ìƒì„± feature
    origin = add_technical_features(origin)
    # ê²°ì¸¡ ì œê±°
    o_cleaned, o_cols_to_drop = drop_sparse_columns(origin, threshold=0.10, check_inf=True, inplace=True)
    origin = o_cleaned
    # ê±°ë˜ì •ì§€/ì´ìƒì¹˜ í–‰ ì œê±°
    origin, o_removed_idx = drop_trading_halt_rows(origin)



    today_str = str(today)
    title = f"{today_str} {stock_name} [{ticker}] {round(data.iloc[-1]['ë“±ë½ë¥ '], 2)}% Daily Chart - {predict} {r_chg_rate:.1f}%"
    final_file_name = f"{today} {stock_name} [{ticker}] {round(data.iloc[-1]['ë“±ë½ë¥ '], 2)}%_{predict}.png"
    output_dir = 'D:\\5below20_test'
    final_file_path = os.path.join(output_dir, final_file_name)

    # ê·¸ë˜í”„ ê·¸ë¦´ ë•Œ í•„ìš”í•œ ê²ƒë§Œ ëª¨ì•„ì„œ ë¦¬í„´
    plot_job = {
        "origin": origin,
        "today": today_str,
        "title": title,
        "save_path": final_file_path,
    }

    return {
        "row": row,
        "plot_job": plot_job,
    }

if __name__ == "__main__":
    tickers_dict = get_kor_ticker_dict_list()

    print('signal_any_drop ë¥¼ í†µí•´ì„œ 5ì¼ì„ ì´ 20ì¼ì„ ë³´ë‹¤ ì•„ë˜ì— ìˆìœ¼ë©´ì„œ ìµœê·¼ -3%ì´ ì¡´ì¬ + ì˜¤ëŠ˜ 3% ì´ìƒ ìƒìŠ¹')

    nowTime = datetime.today().strftime("%Y-%m-%d %H:%M:%S")
    print(f'        {nowTime}: running 4_find_low_point.py...')
    start = time.time()   # ì‹œì‘ ì‹œê°„(ì´ˆ)

    shortfall_cnt = 0
    up_cnt = 0
    rows=[]
    plot_jobs = []

    origin_idx = idx = 9
    workers = os.cpu_count()
    # with ThreadPoolExecutor(max_workers=workers) as executor:   # GIL(Global Interpreter Lock) >> I/Oê°€ ë§ì€ ê²½ìš°
    with ProcessPoolExecutor(max_workers=workers) as executor:   # CPUë¥¼ ì§„ì§œë¡œ ë³‘ë ¬ë¡œ ëŒë¦¬ê³  ì‹¶ìœ¼ë©´ >> CPUì—°ì‚°ì´ ë§ì€ ê²½ìš°
        futures = []

        while idx <= origin_idx + 29:
            idx += 1
            for count, ticker in enumerate(tickers):
                futures.append(executor.submit(process_one, idx, count, ticker, tickers_dict))

        # ì™„ë£Œëœ ê²ƒë¶€í„° í•˜ë‚˜ì”© ë°›ì•„ì„œ ì§‘ê³„
        for f in as_completed(futures):
            try:
                res = f.result()
            except Exception as e:
                print("worker error:", e)
                continue

            if res is None:
                continue

            row = res["row"]
            plot_job = res["plot_job"]

            rows.append(row)
            plot_jobs.append(plot_job)

            if row["predict"] == "ë¯¸ë‹¬":
                shortfall_cnt += 1
            else:
                up_cnt += 1

    '''
    ê³µí†µì  â‘  ëŒ€ë¶€ë¶„ "ìµœê·¼ 20ì¼ í‰ê·  ë“±ë½ë¥  â‰¥ 0%"
    ê³µí†µì  â‘¡ ìµœê·¼ 20ì¼ ë³€ë™ì„± > 2.5% ìˆ˜ì¤€
    ê³µí†µì  â‘¢ 4ê°œì›” ìµœì € ëŒ€ë¹„ ìµœê³  ë“±ë½ë¥ ì´ 40%~80% êµ¬ê°„ì— ëª°ë¦¼
    ê³µí†µì  â‘£ 4ê°œì›” ì¢…ê°€ ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥ ì´ -40%ë³´ë‹¤ í›¨ì”¬ ìœ„(ìƒìœ„ê¶Œì— ìœ„ì¹˜) >> í•˜ë½ì´ í° ë§Œí¼ íšŒë³µë„ í¬ë‹¤ 3í•  íƒ€ìœ¨
    ê³µí†µì  â‘¤ ì£¼ë´‰ ì²«ì£¼ ëŒ€ë¹„ ë“±ë½ë¥ ì´ ë§¤ìš° ë†’ì€ ê²½ìš°ê°€ ë‹¤ìˆ˜
    ê³µí†µì  â‘¥ ëŒ€ë¶€ë¶„ 'ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥ 'ì´ 5% ì´ìƒ
    
    ğŸ”¥ ìˆ˜ìµë¥  ë†’ì€ ì¢…ëª©ì˜ 6ëŒ€ ê³µí†µ íŒ¨í„´
    1) ìµœê·¼ 20ì¼ í‰ê·  ë“±ë½ë¥  â‰¥ 0% ê·¼ì²˜(ì•½ -0.3% ~ +0.5%)
      ê³„ì† ìŒ“ì´ëŠ” â€œì¡°ìš©í•œ ìƒìŠ¹ ì••ë ¥â€
    2) ë³€ë™ì„± 2.5~4.5%
      ë„ˆë¬´ ë‚®ì§€ ì•Šìœ¼ë©´ ìƒìŠ¹ ì—ë„ˆì§€ê°€ ìˆë‹¤.
    3) 4ê°œì›” ìµœì € ëŒ€ë¹„ ìµœê³  ë“±ë½ë¥  40~70%
      ì¤‘ê¸° ì¶”ì„¸ê°€ ì´ë¯¸ ì‚´ì•„ ìˆëŠ” ì¢…ëª©.
    4) ê³ ì  ëŒ€ë¹„ ë‚™í­ -5% ~ -25%
      ê³ ì  ëŒ€ë¹„ ë„ˆë¬´ ë¹ ì§„ ì¢…ëª©ì€ ê²€ì¦ ì„±ê³¼ê°€ ë‚˜ì¨.
    5) ì£¼ë´‰ ì²«ì§¸ì£¼ ëŒ€ë¹„ ê¸ˆì£¼ ë“±ë½ë¥ ì´ í”ŒëŸ¬ìŠ¤
      ì£¼ë´‰ ì¶”ì„¸ê°€ ìš°ìƒí–¥ì¸ ì¢…ëª©ì´ ê°•í–ˆë‹¤.
    6) ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥  +5% ì´ìƒ
      ì§ì „ 1ì£¼ì¼ ëª¨ë©˜í…€ì´ ë§¤ìš° ì¤‘ìš”í–ˆë‹¤.
      ì´ ìƒìŠ¹ì´ ê²€ì¦ ìˆ˜ìµë¥ ê³¼ ê°€ì¥ ì§ì ‘ì  ìƒê´€ì´ ë†’ìŒ.
    '''
    # ğŸ”¥ ì—¬ê¸°ì„œ í•œ ë²ˆì—, ê¹”ë”í•˜ê²Œ ì¶œë ¥
    for row in rows:
        print(f"\n {row['today']}   {row['stock_name']} [{row['ticker']}] {row['predict']}")
        # print(f"  4ê°œì›” ì „ ë‚ ì§œ           : {row['4_months_ago']}")
        # print(f"  ì§ì „ 3ì¼ í‰ê·  ê±°ë˜ëŒ€ê¸ˆ  : {row['mean_prev3'] / 100_000_000:.0f}ì–µ")
        # print(f"  ì˜¤ëŠ˜ ê±°ë˜ëŒ€ê¸ˆ           : {row['today_tr_val'] / 100_000_000:.0f}ì–µ")
        # print(f"  ê±°ë˜ëŒ€ê¸ˆ ë³€ë™ë¥          : {row['chg_tr_val']}%")
        # print(f"  20ì¼ì„  ê¸°ìš¸ê¸° ( > -1.7): {row['ma20_chg_rate']}")
        print(f"  ìµœê·¼ 20ì¼ ë³€ë™ì„±            ( > 1.5%): {row['vol20']}%")
        print(f"  ìµœê·¼ 20ì¼ í‰ê·  ë“±ë½ë¥             ( >= -0.5%): {row['mean_ret20']}%")      # -3% ë³´ë‹¤ ì»¤ì•¼í•¨
        # print(f"  ìµœê·¼ 30ì¼ ì¤‘ ì–‘ë´‰ ë¹„ìœ¨      ( > 30%) : {row['pos_ratio']}%")
        print(f"  4ê°œì›” ì¢…ê°€ ìµœì € ëŒ€ë¹„ ìµœê³  ë“±ë½ë¥  (30% ~ 80%): {row['m_chg_rate']}%" )    # 30 ~ 65 ì„ í˜¸, 28-30ì´í•˜ ì• ë§¤, 70ì´ìƒ ê³¼ì—´
        print(f"  4ê°œì›” ì¢…ê°€ ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥    ( > -40%): {row['c_chg_rate']}%")     # -10(15) ~ -25(30) ì„ í˜¸, -10(15)ì´ìƒì€ ì•„ì§ ê³ ì , -25(30) ì•„ë˜ëŠ” ë¯¸ë‹¬ì¼ ê²½ìš°ê°€ ìˆìŒ
        print(f"  4ê°œì›” ì£¼ë´‰ ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥  ( > -20%): {row['pct_vs_first']}%")   # -15 ~ 20 ì„ í˜¸, -20ì´í•˜ëŠ” ì¥ê¸° í•˜ë½ ì¶”ì„¸, 30ì´ìƒì€ ê¸‰ë“± ëë¬¼
        print(f"  ì§€ë‚œì£¼ ëŒ€ë¹„ ë“±ë½ë¥ : {row['pct_vs_lastweek']}%")
        print(f"  ì˜¤ëŠ˜ ë“±ë½ë¥        : {row['today_pct']}%")
        print(f"  ê²€ì¦ ë“±ë½ë¥        : {row['r_chg_rate']}%")

    print('shortfall_cnt', shortfall_cnt)
    print('up_cnt', up_cnt)
    total_up_rate = up_cnt/(shortfall_cnt+up_cnt)*100
    print(f"ì €ì  ë§¤ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ê²°ê³¼ : {total_up_rate:.2f}%")


    # CSV ì €ì¥
    pd.DataFrame(rows).to_csv('low_result.csv')
    df = pd.read_csv("low_result.csv")

    # # ì„±ê³µ/ì‹¤íŒ¨ í‰ê·  ë¹„êµ
    # print(df.groupby('success')[['m_chg_rate','c_chg_rate','pct_vs_first',
    #                              'pct_vs_lastweek','today_pct','chg_tr_val']].mean())
    #
    # # ì˜ˆë¥¼ ë“¤ì–´ c_chg_rate ë¶„í¬ ë‚˜ëˆ ë³´ê¸°
    # bins = [-40, -30, -25, -20, -15, -10]
    # df['cur_bin'] = pd.cut(df['c_chg_rate'], bins)
    #
    # print(df.pivot_table(index='cur_bin', columns='success', values='ticker', aggfunc='count'))

    success = df[df["label"] == 1]
    fail    = df[df["label"] == 0]

    # ìµœê³  ëŒ€ë¹„ ì˜¤ëŠ˜ ë“±ë½ë¥ , ì²«ì£¼ ëŒ€ë¹„ ì´ë²ˆì£¼ ë“±ë½ë¥ , ê±°ë˜ëŒ€ê¸ˆ ë³€ë™ë¥ 
    print(success[["c_chg_rate", "pct_vs_first", "chg_tr_val"]].mean())
    print(fail[["c_chg_rate", "pct_vs_first", "chg_tr_val"]].mean())




    # ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ê·¸ë˜í”„ ì²˜ë¦¬
    for job in plot_jobs:
        # ê·¸ë˜í”„ ìƒì„±
        fig = plt.figure(figsize=(14, 16), dpi=150)
        gs = fig.add_gridspec(nrows=4, ncols=1, height_ratios=[3, 1, 3, 1])

        ax_d_price = fig.add_subplot(gs[0, 0])
        ax_d_vol   = fig.add_subplot(gs[1, 0], sharex=ax_d_price)
        ax_w_price = fig.add_subplot(gs[2, 0])
        ax_w_vol   = fig.add_subplot(gs[3, 0], sharex=ax_w_price)

        plot_candles_daily(job["origin"], show_months=6, title=f'{job["title"]}',
                            ax_price=ax_d_price, ax_volume=ax_d_vol, date_tick=5, today=job["today"])

        plot_candles_weekly(job["origin"], show_months=12, title="Weekly Chart",
                            ax_price=ax_w_price, ax_volume=ax_w_vol, date_tick=5)

        plt.tight_layout()
        # plt.show()

        # íŒŒì¼ ì €ì¥ (ì˜µì…˜)
        output_dir = 'D:\\5below20_test'
        os.makedirs(output_dir, exist_ok=True)

        plt.savefig(job["save_path"])
        plt.close()
    print('ê·¸ë˜í”„ ìƒì„± ì™„ë£Œ')



    end = time.time()     # ë ì‹œê°„(ì´ˆ)
    elapsed = end - start

    print(f"ì´ ì†Œìš” ì‹œê°„: {elapsed:.2f}ì´ˆ")
