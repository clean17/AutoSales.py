
import matplotlib
matplotlib.use("Agg")  # âœ… ë¹„ì¸í„°ë™í‹°ë¸Œ ë°±ì—”ë“œ (ì°½ ì•ˆ ë„ì›€)
import os, sys
ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if ROOT not in sys.path:
    sys.path.insert(0, ROOT)
import pandas as pd
from datetime import datetime, timedelta
from pathlib import Path
import matplotlib.pyplot as plt
import requests
import time
from concurrent.futures import ProcessPoolExecutor, as_completed


# ìë™ íƒìƒ‰ (utils.pyë¥¼ ì°¾ì„ ë•Œê¹Œì§€ ìœ„ë¡œ ì˜¬ë¼ê°€ íƒìƒ‰)
here = Path(__file__).resolve()
for parent in [here.parent, *here.parents]:
    if (parent / "utils.py").exists():
        sys.path.insert(0, str(parent))
        break
else:
    raise FileNotFoundError("utils.pyë¥¼ ìƒìœ„ ë””ë ‰í„°ë¦¬ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

from utils import add_technical_features, plot_candles_weekly, plot_candles_daily, \
    drop_sparse_columns, drop_trading_halt_rows, get_kor_summary_ticker_dict_list, get_favorite_ticker_dict_list

# í˜„ì¬ ì‹¤í–‰ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¡ê¸°
root_dir = os.path.dirname(os.path.abspath(__file__))  # ì‹¤í–‰í•˜ëŠ” íŒŒì´ì¬ íŒŒì¼ ìœ„ì¹˜(=ë£¨íŠ¸)
pickle_dir = os.path.join(root_dir, '../pickle')
output_dir = 'D:\\interest_stocks'



def process_one(idx, count, ticker, tickers_dict):
    stock_name = tickers_dict.get(ticker, 'Unknown Stock')

    filepath = os.path.join(pickle_dir, f'{ticker}.pkl')
    if not os.path.exists(filepath):
        print(f"[idx={idx}] {ticker} íŒŒì¼ ì—†ìŒ")
        return

    data = pd.read_pickle(filepath)


    today = data.index[-1].strftime("%Y%m%d") # ë§ˆì§€ë§‰ ì¸ë±ìŠ¤
    created_at = data.index[-1].strftime("%Y-%m-%d") # ë§ˆì§€ë§‰ ì¸ë±ìŠ¤


    # 2ì°¨ ìƒì„± feature
    data = add_technical_features(data)

    # ê²°ì¸¡ ì œê±°
    cleaned, cols_to_drop = drop_sparse_columns(data, threshold=0.10, check_inf=True, inplace=True)
    data = cleaned

    # ê±°ë˜ì •ì§€/ì´ìƒì¹˜ í–‰ ì œê±°
    data, removed_idx = drop_trading_halt_rows(data)



    today_str = str(today)
    title = f"{today_str} {stock_name} [{ticker}] Daily Chart"
    final_file_name = f"{today} {stock_name} [{ticker}].webp"
    os.makedirs(output_dir, exist_ok=True)
    final_file_path = os.path.join(output_dir, final_file_name)

    # ê·¸ë˜í”„ ê·¸ë¦´ ë•Œ í•„ìš”í•œ ê²ƒë§Œ ëª¨ì•„ì„œ ë¦¬í„´
    plot_job = {
        "origin": data,
        "today": today_str,
        "title": title,
        "save_path": final_file_path,
    }


    try:
        requests.post(
            'https://chickchick.shop/stocks/interest/graph',
            json={
                "nation": "kor",
                "stock_code": str(ticker),
                "stock_name": str(stock_name),
                "graph_file": str(final_file_name),
            },
            timeout=10
        )
    except Exception as e:
        # logging.warning(f"progress-update ìš”ì²­ ì‹¤íŒ¨: {e}")
        print(f"progress-update ìš”ì²­ ì‹¤íŒ¨-4-1: {e}")
        pass  # ì˜¤ë¥˜


    return {
        "plot_job": plot_job,
    }



if __name__ == "__main__":
    start = time.time()   # ì‹œì‘ ì‹œê°„(ì´ˆ)
    nowTime = datetime.now().strftime("%Y-%m-%d %H:%M:%S,%f")[:-3]
    print(f'{nowTime} - ğŸ•’ running 5_generate_interest_stocks_graph.py...')

    tickers_dict = get_kor_summary_ticker_dict_list()
    fav_tickers_dict = get_favorite_ticker_dict_list()
    tickers = list(set(tickers_dict.keys()) | set(fav_tickers_dict.keys()))  # | ëŠ” í•©ì§‘í•© ì—°ì‚°ì
    # tickers = list(set(tickers_dict.keys()))

    plot_jobs = []

    origin_idx = idx = -1  # ì˜¤ëŠ˜ // 3 (5ì¼ ì „)
    # origin_idx = idx = 1
    workers = os.cpu_count()
    # with ThreadPoolExecutor(max_workers=workers) as executor:   # GIL(Global Interpreter Lock) >> I/Oê°€ ë§ì€ ê²½ìš°
    with ProcessPoolExecutor(max_workers=workers-4) as executor:   # CPUë¥¼ ì§„ì§œë¡œ ë³‘ë ¬ë¡œ ëŒë¦¬ê³  ì‹¶ìœ¼ë©´ >> CPUì—°ì‚°ì´ ë§ì€ ê²½ìš°
        futures = []

        while idx <= origin_idx:
            idx += 1
            for count, ticker in enumerate(tickers):
                futures.append(executor.submit(process_one, idx, count, ticker, tickers_dict))

        # ì™„ë£Œëœ ê²ƒë¶€í„° í•˜ë‚˜ì”© ë°›ì•„ì„œ ì§‘ê³„
        for f in as_completed(futures):
            try:
                res = f.result()
            except Exception as e:
                print("worker error:", e)
                continue

            if res is None:
                continue

            plot_job = res["plot_job"]
            plot_jobs.append(plot_job)


    # ì‹±ê¸€ ìŠ¤ë ˆë“œë¡œ ê·¸ë˜í”„ ì²˜ë¦¬
    for job in plot_jobs:
        # ê·¸ë˜í”„ ìƒì„±
        fig = plt.figure(figsize=(14, 16), dpi=150)
        gs = fig.add_gridspec(nrows=4, ncols=1, height_ratios=[3, 1, 3, 1])

        ax_d_price = fig.add_subplot(gs[0, 0])
        ax_d_vol   = fig.add_subplot(gs[1, 0], sharex=ax_d_price)
        ax_w_price = fig.add_subplot(gs[2, 0])
        ax_w_vol   = fig.add_subplot(gs[3, 0], sharex=ax_w_price)

        plot_candles_daily(job["origin"], show_months=4, title=f'{job["title"]}',
                           ax_price=ax_d_price, ax_volume=ax_d_vol, date_tick=5)

        plot_candles_weekly(job["origin"], show_months=12, title="Weekly Chart",
                            ax_price=ax_w_price, ax_volume=ax_w_vol, date_tick=5)

        plt.tight_layout()
        # plt.show()

        # íŒŒì¼ ì €ì¥ (ì˜µì…˜)
        plt.savefig(job["save_path"], format="webp", dpi=100, bbox_inches="tight", pad_inches=0.1)
        plt.close()
    print('\nê·¸ë˜í”„ ê°±ì‹  ì™„ë£Œ')

    end = time.time()     # ë ì‹œê°„(ì´ˆ)
    elapsed = end - start

    hours, remainder = divmod(int(elapsed), 3600)
    minutes, seconds = divmod(remainder, 60)

    if elapsed > 20:
        print(f"ì´ ì†Œìš” ì‹œê°„: {hours}ì‹œê°„ {minutes}ë¶„ {seconds}ì´ˆ")

